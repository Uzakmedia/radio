<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Uzak Media Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #0e0e0e;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      padding: 20px;
      flex-direction: column;
      align-items: center;
    }

    .container {
      display: flex;
      width: 100%;
      max-width: 900px;
      gap: 20px;
    }

    #chat-area {
      flex: 3;
    }

    #chat-box {
      background: #1b1b1b;
      border-radius: 8px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
      word-wrap: break-word;
      position: relative;
    }

    .moderator {
      background-color: #222f66;
      color: #ffea00;
    }

    .user {
      background-color: #292929;
    }

    .admin {
      background-color: #661111;
      color: #ffffff;
    }

    .delete-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    #chat-form {
      display: flex;
      gap: 10px;
    }

    #message-input {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: none;
      outline: none;
    }

    #send-button, #change-nick-button {
      padding: 10px 15px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #nickname {
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }

    #online-users {
      flex: 1;
      background: #161616;
      border-radius: 8px;
      padding: 10px;
      height: 460px;
      overflow-y: auto;
    }

    #online-users h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }

    .user-item {
      font-size: 0.9rem;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>

<h1>UZAK MEDIA CHAT</h1>

<div class="container">
  <div id="chat-area">
    <div id="nickname"></div>
    <div id="chat-box"></div>

    <form id="chat-form">
      <input type="text" id="message-input" placeholder="Mesaj yaz..." maxlength="200" required />
      <button type="submit" id="send-button">GÃ¶nder</button>
      <button type="button" id="change-nick-button">Nickimi DeÄŸiÅŸtir</button>
    </form>
  </div>

  <div id="online-users">
    <h3>ðŸ”¸ Ã‡evrimiÃ§i</h3>
    <div id="user-list"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, set, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBBBsr9Zjveq6MYdMuwVgAVGgEP_6AmPU0",
    authDomain: "uzak-media-chat.firebaseapp.com",
    databaseURL: "https://uzak-media-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "uzak-media-chat",
    storageBucket: "uzak-media-chat.firebasestorage.app",
    messagingSenderId: "353010124754",
    appId: "1:353010124754:web:11af752d0bffac765f2a0b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");
  const onlineRef = ref(db, "onlineUsers");

  const moderatorList = ["admin", "serhat06", "faruk52", "sinan07"];

  function generateNick() {
    const fruits = ["elma", "portakal", "mandalina", "avokado", "erik", "mango"];
    const name = fruits[Math.floor(Math.random() * fruits.length)] + "_" + Math.floor(Math.random() * 10000);
    return name;
  }

  async function getUniqueNick() {
    let newNick;
    let exists = true;
    while (exists) {
      newNick = generateNick();
      const snapshot = await get(ref(db, `onlineUsers`));
      exists = false;
      snapshot.forEach(child => {
        if (child.val().nick === newNick) exists = true;
      });
    }
    return newNick;
  }

  async function assignNick(force = false) {
    if (!localStorage.getItem("uzakmedia_nick") || force) {
      const nick = await getUniqueNick();
      localStorage.setItem("uzakmedia_nick", nick);
      location.reload();
    }
  }

  document.getElementById("change-nick-button").addEventListener("click", () => assignNick(true));

  let nickname = localStorage.getItem("uzakmedia_nick");
  if (!nickname) assignNick();

  const userKey = nickname + "_" + Math.floor(Math.random() * 10000);
  document.getElementById("nickname").innerText = `ðŸ§‘ Takma adÄ±nÄ±z: ${nickname}`;

  function setOnline() {
    set(ref(db, `onlineUsers/${userKey}`), {
      nick: nickname,
      timestamp: Date.now()
    });
  }

  setOnline();
  setInterval(setOnline, 20000);

  window.addEventListener("beforeunload", () => {
    remove(ref(db, `onlineUsers/${userKey}`));
  });

  document.getElementById("chat-form").addEventListener("submit", function(e) {
    e.preventDefault();
    const text = document.getElementById("message-input").value.trim();
    if (text.length > 0) {
      push(messagesRef, {
        user: nickname,
        text: text,
        time: new Date().toLocaleTimeString("tr-TR")
      });
      document.getElementById("message-input").value = "";
    }
  });

  onChildAdded(messagesRef, function(snapshot) {
    const msg = snapshot.val();
    const msgKey = snapshot.key;
    const msgDiv = document.createElement("div");
    const isMod = moderatorList.includes(nickname);
    const isAdmin = nickname === "admin";

    msgDiv.classList.add("message");
    msgDiv.classList.add(msg.user === "admin" ? "admin" : moderatorList.includes(msg.user) ? "moderator" : "user");
    msgDiv.innerHTML = `<strong>${msg.user}</strong> <small style="float:right">${msg.time}</small><br>${msg.text}`;

    if (isMod || isAdmin) {
      const delBtn = document.createElement("button");
      delBtn.innerText = "Sil";
      delBtn.className = "delete-button";
      delBtn.onclick = () => remove(child(messagesRef, msgKey));
      msgDiv.appendChild(delBtn);
    }

    document.getElementById("chat-box").appendChild(msgDiv);
    document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
  });

  onValue(onlineRef, function(snapshot) {
    const userList = document.getElementById("user-list");
    userList.innerHTML = "";
    const now = Date.now();

    snapshot.forEach(child => {
      const data = child.val();
      if (now - data.timestamp < 30000) {
        const div = document.createElement("div");
        div.classList.add("user-item");
        div.innerText = data.nick;
        userList.appendChild(div);
      }
    });
  });
</script>
</body>
</html>
